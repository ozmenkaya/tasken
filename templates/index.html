{% extends "base.html" %}

{% block content %}
<div class="row g-2">
    <div class="col-12">
        <!-- Mobile Header -->
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 mb-sm-4">
            <h2 class="mb-2 mb-sm-0">
                <i class="fas fa-list-check"></i> 
                <span class="d-none d-sm-inline">Görevler</span>
                <span class="d-inline d-sm-none">Görevler</span>
            </h2>
        </div>

        <!-- Mobile-Optimized Filters -->
        <div class="card mb-3 mb-sm-4">
            <div class="card-body p-2 p-sm-3">
                <div class="row g-2">
                    <div class="col-6 col-md-3">
                        <select class="form-select form-select-sm" id="statusFilter">
                            <option value="">Tüm Durumlar</option>
                            <option value="pending">Beklemede</option>
                            <option value="in_progress">Devam Ediyor</option>
                            <option value="completed">Tamamlandı</option>
                            <option value="cancelled">İptal Edildi</option>
                        </select>
                    </div>
                    <div class="col-6 col-md-3">
                        <select class="form-select form-select-sm" id="priorityFilter">
                            <option value="">Tüm Öncelikler</option>
                            <option value="urgent">Acil</option>
                            <option value="high">Yüksek</option>
                            <option value="medium">Orta</option>
                            <option value="low">Düşük</option>
                        </select>
                    </div>
                    <div class="col-12 col-md-6">
                        <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="Görev ara...">
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile-Optimized Reminders Widget -->
        <div class="card mb-3 mb-sm-4" id="todayRemindersCard" style="display: none;">
            <div class="card-header bg-primary text-white p-2 p-sm-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-bell"></i> 
                        <span class="d-none d-sm-inline">Bugünün Anımsatıcıları</span>
                        <span class="d-inline d-sm-none">Anımsatıcılar</span>
                    </h6>
                    <a href="{{ url_for('reminders') }}" class="btn btn-sm btn-light">
                        <span class="d-none d-sm-inline">Tümünü Gör</span>
                        <span class="d-inline d-sm-none">Tümü</span>
                    </a>
                </div>
            </div>
            <div class="card-body p-2 p-sm-3" id="todayRemindersList">
                <!-- Anımsatıcılar buraya yüklenecek -->
            </div>
        </div>

        <!-- Mobile-Optimized Task Tabs -->
        <div class="card">
            <div class="card-header p-0">
                <ul class="nav nav-tabs card-header-tabs flex-nowrap overflow-auto" id="taskTabs" role="tablist" style="border-bottom: none;">
                    {% if current_user.role == 'admin' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-nowrap px-2 px-sm-3" id="all-tasks-tab" data-bs-toggle="tab" data-bs-target="#all-tasks" type="button" role="tab">
                                <i class="fas fa-list"></i> 
                                <span class="d-none d-sm-inline">Aktif Görevler</span>
                                <span class="d-inline d-sm-none">Aktif</span>
                                <span class="badge bg-primary ms-1">{{ tasks|length }}</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-nowrap px-2 px-sm-3" id="completed-tasks-tab" data-bs-toggle="tab" data-bs-target="#completed-tasks" type="button" role="tab">
                                <i class="fas fa-check-circle"></i> 
                                <span class="d-none d-sm-inline">Tamamlananlar</span>
                                <span class="d-inline d-sm-none">Tamam</span>
                                <span class="badge bg-success ms-1">{{ completed_tasks|length }}</span>
                            </button>
                        </li>
                    {% else %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active text-nowrap px-2 px-sm-3" id="assigned-tasks-tab" data-bs-toggle="tab" data-bs-target="#assigned-tasks" type="button" role="tab">
                                <i class="fas fa-user"></i> 
                                <span class="d-none d-sm-inline">Bana Atananlar</span>
                                <span class="d-inline d-sm-none">Bana</span>
                                <span class="badge bg-info ms-1">{{ assigned_tasks|length }}</span>
                            </button>
                        </li>
                        {% if created_tasks|length > 0 %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-nowrap px-2 px-sm-3" id="created-tasks-tab" data-bs-toggle="tab" data-bs-target="#created-tasks" type="button" role="tab">
                                <i class="fas fa-plus-circle"></i> 
                                <span class="d-none d-sm-inline">Atadıklarım</span>
                                <span class="d-inline d-sm-none">Attığım</span>
                                <span class="badge bg-success ms-1">{{ created_tasks|length }}</span>
                            </button>
                        </li>
                        {% endif %}
                        {% if current_user.role == 'manager' %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-nowrap px-2 px-sm-3" id="dept-tasks-tab" data-bs-toggle="tab" data-bs-target="#dept-tasks" type="button" role="tab">
                                <i class="fas fa-building"></i> 
                                <span class="d-none d-lg-inline">Departman Görevleri</span>
                                <span class="d-none d-sm-inline d-lg-none">Departman</span>
                                <span class="d-inline d-sm-none">Dept</span>
                                <span class="badge bg-warning ms-1">{{ tasks|length }}</span>
                            </button>
                        </li>
                        {% endif %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link text-nowrap px-2 px-sm-3" id="completed-tasks-tab" data-bs-toggle="tab" data-bs-target="#completed-tasks" type="button" role="tab">
                                <i class="fas fa-check-circle"></i> 
                                <span class="d-none d-sm-inline">Tamamlananlar</span>
                                <span class="d-inline d-sm-none">Tamam</span>
                                <span class="badge bg-success ms-1">{{ (assigned_completed_tasks|length + created_completed_tasks|length) if current_user.role != 'employee' else assigned_completed_tasks|length }}</span>
                            </button>
                        </li>
                    {% endif %}
                </ul>
            </div>
            <div class="card-body p-2 p-sm-3">
                <div class="tab-content" id="taskTabsContent">
                    {% if current_user.role == 'admin' %}
                        <!-- Admin: Aktif Görevler -->
                        <div class="tab-pane fade show active" id="all-tasks" role="tabpanel">
                            <div class="mb-3">
                                <h6><i class="fas fa-info-circle text-primary"></i> Sistemdeki aktif görevler (Admin görünümü)</h6>
                            </div>
                            <!-- Kart Görünümü -->
                            <div class="row task-container card-view d-none" data-task-type="all" id="card-container-all">
                                {% for task in tasks %}
                                    {% include 'task_card_partial.html' %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info text-center">
                                            <i class="fas fa-info-circle"></i> Henüz görev bulunmuyor.
                                            <a href="{{ url_for('create_task') }}" class="btn btn-primary btn-sm ms-2">
                                                İlk görevi oluştur
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Liste Görünümü -->
                            <div class="list-view" id="list-container-all">
                                {% if tasks %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Görev</th>
                                                <th>Atanan</th>
                                                <th>Oluşturan</th>
                                                <th>Öncelik</th>
                                                <th>Durum</th>
                                                <th>Son Tarih</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for task in tasks %}
                                            <tr class="task-row" id="task-row-{{ task.id }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                                                <td>
                                                    <div>
                                                        <strong>
                                                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a>
                                                            {% if task.is_read_by(current_user) %}
                                                            <i class="fas fa-eye text-success ms-2" title="Okundu"></i>
                                                            {% else %}
                                                            <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                                                            {% endif %}
                                                        </strong>
                                                        {% if task.description %}
                                                        <br>
                                                        <small class="text-muted d-none d-md-block">{{ (task.description|striptags)[:100] }}{% if (task.description|striptags)|length > 100 %}...{% endif %}</small>
                                                        {% endif %}</div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{% if task.assignees %}{% for assignee in task.assignees %}{{ assignee.username }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}Atanmamış{% endif %}</span>
                                                    {% if false %}
                                                    <br><small class="text-muted">{{ "" }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{{ task.creator.username }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                                        {{ {'urgent': 'Acil', 'high': 'Yüksek', 'medium': 'Orta', 'low': 'Düşük'}[task.priority] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'warning' if task.status == 'pending' else 'primary' if task.status == 'in_progress' else 'success' if task.status == 'completed' else 'danger' }}">
                                                        {{ {'pending': 'Beklemede', 'in_progress': 'Devam Ediyor', 'completed': 'Tamamlandı', 'cancelled': 'İptal Edildi'}[task.status] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if task.due_date %}
                                                        <small class="{% if task.due_date < moment.utcnow() and task.status != 'completed' %}text-danger{% else %}text-muted{% endif %}">
                                                            {{ task.due_date|format_date }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if task.status != 'completed' and (current_user.role in ['admin', 'manager'] or current_user in task.assignees) %}
                                                    <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick='completeTask({{ task.id }}, {{ task.title|tojson|forceescape }})' title="Tamamlandı İşaretle">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if current_user.role == 'admin' or task.created_by == current_user.id %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick='deleteTask({{ task.id }}, {{ task.title|tojson|forceescape }})'>
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if task.description %}
                                            <tr class="task-description-row d-table-row d-md-none" data-status="{{ task.status }}">
                                                <td colspan="5" class="task-description-cell">
                                                    <small class="text-muted">{{ (task.description|striptags)[:50] }}{% if (task.description|striptags)|length > 50 %}...{% endif %}</small>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-info-circle"></i> Henüz görev bulunmuyor.
                                    <a href="{{ url_for('create_task') }}" class="btn btn-primary btn-sm ms-2">
                                        İlk görevi oluştur
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Admin: Tamamlanan Görevler -->
                        <div class="tab-pane fade" id="completed-tasks" role="tabpanel">
                            <div class="mb-3">
                                <h6><i class="fas fa-check-circle text-success"></i> Tamamlanan görevler (Admin görünümü)</h6>
                            </div>
                            <!-- Liste Görünümü -->
                            <div class="list-view" id="list-container-completed">
                                {% if completed_tasks %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Görev</th>
                                                <th>Atanan</th>
                                                <th>Oluşturan</th>
                                                <th>Öncelik</th>
                                                <th>Tamamlanma Tarihi</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="task-tbody">
                                            {% for task in completed_tasks %}
                                            <tr class="task-row table-success" id="task-row-{{ task.id }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                                                <td>
                                                    <div>
                                                        <strong>
                                                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a>
                                                            {% if task.is_read_by(current_user) %}
                                                            <i class="fas fa-eye text-success ms-2" title="Okundu"></i>
                                                            {% else %}
                                                            <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                                                            {% endif %}
                                                        </strong>
                                                        {% if task.description %}
                                                        <br>
                                                        <small class="text-muted d-none d-md-block">{{ (task.description|striptags)[:100] }}{% if (task.description|striptags)|length > 100 %}...{% endif %}</small>
                                                        {% endif %}</div>
                                                </td>
                                                <td>
                                                    {% if task.assignees %}
                                                        {% for assignee in task.assignees %}
                                                        <span class="badge bg-light text-dark">{{ assignee.username }}</span>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="badge bg-secondary text-white">Atanmamış</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{{ task.creator.username }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                                        {{ {'urgent': 'Acil', 'high': 'Yüksek', 'medium': 'Orta', 'low': 'Düşük'}[task.priority] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if task.completed_at %}
                                                        <small class="text-success">
                                                            {{ task.completed_at|format_datetime }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if current_user.role == 'admin' or task.created_by == current_user.id %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick='deleteTask({{ task.id }}, {{ task.title|tojson|forceescape }})'>
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if task.description %}
                                            <tr class="task-description-row d-table-row d-md-none" data-status="{{ task.status }}">
                                                <td colspan="5" class="task-description-cell">
                                                    <small class="text-muted">{{ (task.description|striptags)[:50] }}{% if (task.description|striptags)|length > 50 %}...{% endif %}</small>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-success text-center">
                                    <i class="fas fa-check-circle"></i> Henüz tamamlanan görev bulunmuyor.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <!-- Bana Atanan Görevler -->
                        <div class="tab-pane fade show active" id="assigned-tasks" role="tabpanel">
                            <div class="mb-3">
                                <h6><i class="fas fa-info-circle text-info"></i> Size atanan görevler</h6>
                            </div>
                            <!-- Kart Görünümü -->
                            <div class="row task-container card-view d-none" data-task-type="assigned" id="card-container-assigned">
                                {% for task in assigned_tasks %}
                                    {% include 'task_card_partial.html' %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info text-center">
                                            <i class="fas fa-inbox"></i> Size atanmış görev bulunmuyor.
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Liste Görünümü -->
                            <div class="list-view" id="list-container-assigned">
                                {% if assigned_tasks %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Görev</th>
                                                <th>Atanan</th>
                                                <th>Oluşturan</th>
                                                <th>Öncelik</th>
                                                <th>Durum</th>
                                                <th>Son Tarih</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="task-tbody">
                                            {% for task in assigned_tasks %}
                                            <tr class="task-row" id="task-row-{{ task.id }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                                                <td>
                                                    <div>
                                                        <strong>
                                                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a>
                                                            {% if task.is_read_by(current_user) %}
                                                            <i class="fas fa-eye text-success ms-2" title="Okundu"></i>
                                                            {% else %}
                                                            <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                                                            {% endif %}
                                                        </strong>
                                                        {% if task.description %}
                                                        <br>
                                                        <small class="text-muted d-none d-md-block">{{ (task.description|striptags)[:100] }}{% if (task.description|striptags)|length > 100 %}...{% endif %}</small>
                                                        {% endif %}</div>
                                                </td>
                                                <td>
                                                    {% if task.assignees %}
                                                        {% for assignee in task.assignees %}
                                                        <span class="badge bg-light text-dark">{{ assignee.username }}</span>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="badge bg-secondary text-white">Atanmamış</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{{ task.creator.username }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                                        {{ {'urgent': 'Acil', 'high': 'Yüksek', 'medium': 'Orta', 'low': 'Düşük'}[task.priority] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'warning' if task.status == 'pending' else 'primary' if task.status == 'in_progress' else 'success' if task.status == 'completed' else 'danger' }}">
                                                        {{ {'pending': 'Beklemede', 'in_progress': 'Devam Ediyor', 'completed': 'Tamamlandı', 'cancelled': 'İptal Edildi'}[task.status] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if task.due_date %}
                                                        <small class="{% if task.due_date < moment.utcnow() and task.status != 'completed' %}text-danger{% else %}text-muted{% endif %}">
                                                            {{ task.due_date|format_date }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if task.status != 'completed' and (current_user.role in ['admin', 'manager'] or current_user in task.assignees) %}
                                                    <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick='completeTask({{ task.id }}, {{ task.title|tojson|forceescape }})' title="Tamamlandı İşaretle">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if task.description %}
                                            <tr class="task-description-row d-table-row d-md-none" data-status="{{ task.status }}">
                                                <td colspan="5" class="task-description-cell">
                                                    <small class="text-muted">{{ (task.description|striptags)[:50] }}{% if (task.description|striptags)|length > 50 %}...{% endif %}</small>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                    <div class="alert alert-info text-center">
                                        <i class="fas fa-inbox"></i> Size atanmış görev bulunmuyor.
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Atadığım Görevler -->
                        {% if created_tasks|length > 0 %}
                        <div class="tab-pane fade" id="created-tasks" role="tabpanel">
                            <div class="mb-3">
                                <h6><i class="fas fa-info-circle text-success"></i> Başkalarına atadığınız görevler</h6>
                            </div>
                            <div class="mb-3">
                                <!-- Durum Özeti -->
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="card bg-warning text-dark">
                                            <div class="card-body text-center py-2">
                                                <small>{{ created_tasks|selectattr("status", "equalto", "pending")|list|length }} Beklemede</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-info text-white">
                                            <div class="card-body text-center py-2">
                                                <small>{{ created_tasks|selectattr("status", "equalto", "in_progress")|list|length }} Devam Ediyor</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center py-2">
                                                <small>{{ created_tasks|selectattr("status", "equalto", "completed")|list|length }} Tamamlandı</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card bg-danger text-white">
                                            <div class="card-body text-center py-2">
                                                <small>{{ created_tasks|selectattr("status", "equalto", "cancelled")|list|length }} İptal</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Kart Görünümü -->
                            <div class="row task-container card-view d-none" data-task-type="created" id="card-container-created">
                                {% for task in created_tasks %}
                                    {% include 'task_card_partial.html' %}
                                {% endfor %}
                            </div>
                            
                            <!-- Liste Görünümü -->
                            <div class="list-view" id="list-container-created">
                                {% if created_tasks %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Görev</th>
                                                <th>Atanan</th>
                                                <th>Oluşturan</th>
                                                <th>Öncelik</th>
                                                <th>Durum</th>
                                                <th>Son Tarih</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="task-tbody">
                                            {% for task in created_tasks %}
                                            <tr class="task-row" id="task-row-{{ task.id }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                                                <td>
                                                    <div>
                                                        <strong>
                                                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a>
                                                            {% if task.is_read_by(current_user) %}
                                                            <i class="fas fa-eye text-success ms-2" title="Okundu"></i>
                                                            {% else %}
                                                            <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                                                            {% endif %}
                                                        </strong>
                                                        {% if task.description %}
                                                        <br>
                                                        <small class="text-muted d-none d-md-block">{{ (task.description|striptags)[:100] }}{% if (task.description|striptags)|length > 100 %}...{% endif %}</small>
                                                        {% endif %}</div>
                                                </td>
                                                <td>
                                                    {% if task.assignees %}
                                                        {% for assignee in task.assignees %}
                                                        <span class="badge bg-light text-dark">{{ assignee.username }}</span>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="badge bg-secondary text-white">Atanmamış</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{{ task.creator.username }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                                        {{ {'urgent': 'Acil', 'high': 'Yüksek', 'medium': 'Orta', 'low': 'Düşük'}[task.priority] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'warning' if task.status == 'pending' else 'primary' if task.status == 'in_progress' else 'success' if task.status == 'completed' else 'danger' }}">
                                                        {{ {'pending': 'Beklemede', 'in_progress': 'Devam Ediyor', 'completed': 'Tamamlandı', 'cancelled': 'İptal Edildi'}[task.status] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if task.due_date %}
                                                        <small class="{% if task.due_date < moment.utcnow() and task.status != 'completed' %}text-danger{% else %}text-muted{% endif %}">
                                                            {{ task.due_date|format_date }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <!-- Açıklama düzenleme butonu - sadece görev oluşturan görebilir -->
                                                    {% if task.created_by == current_user.id %}
                                                    <button type="button" class="btn btn-sm btn-outline-warning ms-1" 
                                                            onclick="editTaskDescription({{ task.id }})" 
                                                            title="Açıklamayı Düzenle">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if task.status != 'completed' and (current_user.role in ['admin', 'manager'] or current_user in task.assignees) %}
                                                    <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick='completeTask({{ task.id }}, {{ task.title|tojson|forceescape }})' title="Tamamlandı İşaretle">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if task.description %}
                                            <tr class="task-description-row d-table-row d-md-none" data-status="{{ task.status }}">
                                                <td colspan="5" class="task-description-cell">
                                                    <small class="text-muted">{{ (task.description|striptags)[:50] }}{% if (task.description|striptags)|length > 50 %}...{% endif %}</small>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                    <div class="alert alert-info text-center">
                                        <i class="fas fa-plus-circle"></i> Henüz kimseye görev atamadınız.
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <!-- Manager: Departman Görevleri -->
                        {% if current_user.role == 'manager' %}
                        <div class="tab-pane fade" id="dept-tasks" role="tabpanel">
                            <div class="mb-3">
                                <h6><i class="fas fa-info-circle text-warning"></i> {{ current_user.department }} departmanındaki tüm görevler</h6>
                            </div>
                            <!-- Kart Görünümü -->
                            <div class="row task-container card-view d-none" data-task-type="department" id="card-container-dept">
                                {% for task in tasks %}
                                    {% include 'task_card_partial.html' %}
                                {% else %}
                                    <div class="col-12">
                                        <div class="alert alert-info text-center">
                                            <i class="fas fa-building"></i> Departmanınızda henüz görev bulunmuyor.
                                            {% if current_user.role in ['admin', 'manager'] %}
                                                <a href="{{ url_for('create_task') }}" class="btn btn-primary btn-sm ms-2">
                                                    İlk görevi oluştur
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Liste Görünümü -->
                            <div class="list-view" id="list-container-dept">
                                {% if tasks %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Görev</th>
                                                <th>Atanan</th>
                                                <th>Oluşturan</th>
                                                <th>Öncelik</th>
                                                <th>Durum</th>
                                                <th>Son Tarih</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for task in tasks %}
                                            <tr class="task-row" id="task-row-{{ task.id }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                                                <td>
                                                    <div>
                                                        <strong>
                                                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a>
                                                            {% if task.is_read_by(current_user) %}
                                                            <i class="fas fa-eye text-success ms-2" title="Okundu"></i>
                                                            {% else %}
                                                            <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                                                            {% endif %}
                                                        </strong>
                                                        {% if task.description %}
                                                        <br>
                                                        <small class="text-muted d-none d-md-block">{{ (task.description|striptags)[:100] }}{% if (task.description|striptags)|length > 100 %}...{% endif %}</small>
                                                        {% endif %}</div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{% if task.assignees %}{% for assignee in task.assignees %}{{ assignee.username }}{% if not loop.last %}, {% endif %}{% endfor %}{% else %}Atanmamış{% endif %}</span>
                                                    {% if false %}
                                                    <br><small class="text-muted">{{ "" }}</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{{ task.creator.username }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                                        {{ {'urgent': 'Acil', 'high': 'Yüksek', 'medium': 'Orta', 'low': 'Düşük'}[task.priority] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'warning' if task.status == 'pending' else 'primary' if task.status == 'in_progress' else 'success' if task.status == 'completed' else 'danger' }}">
                                                        {{ {'pending': 'Beklemede', 'in_progress': 'Devam Ediyor', 'completed': 'Tamamlandı', 'cancelled': 'İptal Edildi'}[task.status] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if task.due_date %}
                                                        <small class="{% if task.due_date < moment.utcnow() and task.status != 'completed' %}text-danger{% else %}text-muted{% endif %}">
                                                            {{ task.due_date|format_date }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if task.status != 'completed' and (current_user.role in ['admin', 'manager'] or current_user in task.assignees) %}
                                                    <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick='completeTask({{ task.id }}, {{ task.title|tojson|forceescape }})' title="Tamamlandı İşaretle">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if task.description %}
                                            <tr class="task-description-row d-table-row d-md-none" data-status="{{ task.status }}">
                                                <td colspan="5" class="task-description-cell">
                                                    <small class="text-muted">{{ (task.description|striptags)[:50] }}{% if (task.description|striptags)|length > 50 %}...{% endif %}</small>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-info text-center">
                                    <i class="fas fa-building"></i> Departmanınızda henüz görev bulunmuyor.
                                    {% if current_user.role in ['admin', 'manager'] %}
                                        <a href="{{ url_for('create_task') }}" class="btn btn-primary btn-sm ms-2">
                                            İlk görevi oluştur
                                        </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Tamamlanan Görevler -->
                        <div class="tab-pane fade" id="completed-tasks" role="tabpanel">
                            <div class="mb-3">
                                <h6><i class="fas fa-check-circle text-success"></i> Tamamlanan görevler</h6>
                            </div>
                            <!-- Liste Görünümü -->
                            <div class="list-view" id="list-container-completed">
                                {% if current_user.role == 'employee' %}
                                    {% set completed_tasks_list = assigned_completed_tasks %}
                                {% else %}
                                    {% set completed_tasks_list = assigned_completed_tasks + created_completed_tasks %}
                                {% endif %}
                                
                                {% if completed_tasks_list %}
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Görev</th>
                                                <th>Atanan</th>
                                                <th>Oluşturan</th>
                                                <th>Öncelik</th>
                                                <th>Tamamlanma Tarihi</th>
                                                <th>İşlemler</th>
                                            </tr>
                                        </thead>
                                        <tbody class="task-tbody">
                                            {% for task in completed_tasks_list %}
                                            <tr class="task-row table-success" id="task-row-{{ task.id }}" data-status="{{ task.status }}" data-priority="{{ task.priority }}">
                                                <td>
                                                    <div>
                                                        <strong>
                                                            <a href="{{ url_for('task_detail', task_id=task.id) }}" class="text-decoration-none">{{ task.title }}</a>
                                                            {% if task.is_read_by(current_user) %}
                                                            <i class="fas fa-eye text-success ms-2" title="Okundu"></i>
                                                            {% else %}
                                                            <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                                                            {% endif %}
                                                        </strong>
                                                        {% if task.description %}
                                                        <br>
                                                        <small class="text-muted d-none d-md-block">{{ (task.description|striptags)[:100] }}{% if (task.description|striptags)|length > 100 %}...{% endif %}</small>
                                                        {% endif %}</div>
                                                </td>
                                                <td>
                                                    {% if task.assignees %}
                                                        {% for assignee in task.assignees %}
                                                        <span class="badge bg-light text-dark">{{ assignee.username }}</span>{% if not loop.last %}, {% endif %}
                                                        {% endfor %}
                                                    {% else %}
                                                        <span class="badge bg-secondary text-white">Atanmamış</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">{{ task.creator.username }}</span>
                                                </td>
                                                <td>
                                                    <span class="badge bg-{{ 'danger' if task.priority == 'urgent' else 'warning' if task.priority == 'high' else 'info' if task.priority == 'medium' else 'secondary' }}">
                                                        {{ {'urgent': 'Acil', 'high': 'Yüksek', 'medium': 'Orta', 'low': 'Düşük'}[task.priority] }}
                                                    </span>
                                                </td>
                                                <td>
                                                    {% if task.completed_at %}
                                                        <small class="text-success">
                                                            {{ task.completed_at|format_datetime }}
                                                        </small>
                                                    {% else %}
                                                        <small class="text-muted">-</small>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if current_user.role == 'admin' or task.created_by == current_user.id %}
                                                    <button type="button" class="btn btn-sm btn-outline-danger ms-1" onclick='deleteTask({{ task.id }}, {{ task.title|tojson|forceescape }})'>
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% if task.description %}
                                            <tr class="task-description-row d-table-row d-md-none" data-status="{{ task.status }}">
                                                <td colspan="5" class="task-description-cell">
                                                    <small class="text-muted">{{ (task.description|striptags)[:50] }}{% if (task.description|striptags)|length > 50 %}...{% endif %}</small>
                                                </td>
                                            </tr>
                                            {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                {% else %}
                                <div class="alert alert-success text-center">
                                    <i class="fas fa-check-circle"></i> Henüz tamamlanan görev bulunmuyor.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Bugünün anımsatıcılarını yükle
    function loadTodayReminders() {
        $.get('/api/today_reminders', function(data) {
            $('#todayRemindersCount').text(data.length);
            
            if (data.length > 0) {
                let reminderHtml = '';
                data.forEach(function(reminder) {
                    reminderHtml += `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                            <div>
                                <strong>${reminder.title}</strong>
                                ${reminder.description ? '<br><small class="text-muted">' + reminder.description + '</small>' : ''}
                            </div>
                            <span class="badge bg-info">${reminder.time}</span>
                        </div>
                    `;
                });
                
                $('#todayRemindersList').html(reminderHtml);
                $('#todayRemindersCard').show();
            } else {
                $('#todayRemindersCard').hide();
            }
        });
    }
    
    // Sayfa yüklendiğinde anımsatıcıları yükle
    loadTodayReminders();
    
    // Filtreleme fonksiyonu - aktif sekmede çalışır
    function filterTasks() {
        const statusFilter = $('#statusFilter').val().toLowerCase();
        const priorityFilter = $('#priorityFilter').val().toLowerCase();
        const searchTerm = $('#searchInput').val().toLowerCase();
        
        // Aktif sekmedeki görevleri filtrele
        const activeTabPane = $('.tab-pane.active');
        activeTabPane.find('.task-item').each(function() {
            const $item = $(this);
            const status = $item.data('status');
            const priority = $item.data('priority');
            const title = $item.data('title');
            const assignee = $item.data('assignee');
            
            let show = true;
            
            // Durum filtresi
            if (statusFilter && status !== statusFilter) {
                show = false;
            }
            
            // Öncelik filtresi
            if (priorityFilter && priority !== priorityFilter) {
                show = false;
            }
            
            // Arama filtresi
            if (searchTerm && !title.includes(searchTerm) && !assignee.includes(searchTerm)) {
                show = false;
            }
            
            $item.toggle(show);
        });
    }
    
    // Sekme değiştiğinde filtreleri sıfırla
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        // Filtreleri sıfırla
        $('#statusFilter').val('');
        $('#priorityFilter').val('');
        $('#searchInput').val('');
        
        // Tüm görevleri göster
        $('.task-item').show();
        
        // Sekme değişikliğinde anımsatıcıları da güncelle
        loadTodayReminders();
    });
    
    // Filtre değişikliklerini dinle
    $('#statusFilter, #priorityFilter, #searchInput').on('change keyup', filterTasks);
    
    // Liste görünümünde filtreleme fonksiyonu
    function filterListTasks() {
        const statusFilter = $('#statusFilter').val().toLowerCase();
        const priorityFilter = $('#priorityFilter').val().toLowerCase();
        const searchTerm = $('#searchInput').val().toLowerCase();
        
        // Aktif sekmedeki liste satırlarını filtrele
        const activeTabPane = $('.tab-pane.active');
        activeTabPane.find('.task-row').each(function() {
            const $row = $(this);
            const status = $row.data('status');
            const priority = $row.data('priority');
            const title = $row.find('strong').text().toLowerCase();
            const assignee = $row.find('.badge').first().text().toLowerCase();
            
            let show = true;
            
            // Durum filtresi
            if (statusFilter && status !== statusFilter) {
                show = false;
            }
            
            // Öncelik filtresi
            if (priorityFilter && priority !== priorityFilter) {
                show = false;
            }
            
            // Arama filtresi
            if (searchTerm && !title.includes(searchTerm) && !assignee.includes(searchTerm)) {
                show = false;
            }
            
            $row.toggle(show);
        });
    }
    
    // Filtre değişikliklerini liste görünümü için de dinle
    $('#statusFilter, #priorityFilter, #searchInput').on('change keyup', function() {
        filterTasks(); // Kart görünümü için
        filterListTasks(); // Liste görünümü için
    });

    // Socket.IO New Task Listener
    if (typeof socket !== 'undefined') {
        socket.on('new_task', function(data) {
            console.log('📋 New task received in index:', data);
            
            // Check if task already exists to prevent duplicates
            if ($(`#task-row-${data.task_id}`).length > 0) {
                return;
            }
            
            // Determine which container to add to
            // If admin, add to 'all-tasks'
            // If employee/manager, add to 'assigned-tasks'
            
            const isAdmin = "{{ current_user.role }}" === 'admin';
            const targetContainerId = isAdmin ? '#list-container-all tbody' : '#list-container-assigned tbody';
            const targetBadgeId = isAdmin ? '#all-tasks-tab .badge' : '#assigned-tasks-tab .badge';
            
            // Priority badge class
            const priorityClasses = {
                'urgent': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'secondary'
            };
            
            const priorityLabels = {
                'urgent': 'Acil',
                'high': 'Yüksek',
                'medium': 'Orta',
                'low': 'Düşük'
            };
            
            // Assignees HTML
            let assigneesHtml = '';
            if (data.assignees && data.assignees.length > 0) {
                data.assignees.forEach((assignee, index) => {
                    assigneesHtml += `<span class="badge bg-light text-dark">${assignee}</span>${index < data.assignees.length - 1 ? ', ' : ''}`;
                });
            } else {
                assigneesHtml = '<span class="badge bg-secondary text-white">Atanmamış</span>';
            }
            
            // Description HTML (truncated)
            let descriptionHtml = '';
            if (data.description) {
                // Strip tags and truncate
                let tmp = document.createElement("DIV");
                tmp.innerHTML = data.description;
                let text = tmp.textContent || tmp.innerText || "";
                let truncated = text.length > 100 ? text.substring(0, 100) + '...' : text;
                descriptionHtml = `<br><small class="text-muted d-none d-md-block">${truncated}</small>`;
            }
            
            // Due Date HTML
            const dueDateHtml = data.due_date ? 
                `<small class="text-muted">${data.due_date}</small>` : 
                `<small class="text-muted">-</small>`;
            
            // New Row HTML
            const newRow = `
                <tr class="task-row" id="task-row-${data.task_id}" data-status="${data.status || 'pending'}" data-priority="${data.priority}">
                    <td>
                        <div>
                            <strong>
                                <a href="/task/${data.task_id}" class="text-decoration-none">${data.title}</a>
                                <i class="fas fa-eye text-danger ms-2" title="Okunmadı"></i>
                            </strong>
                            ${descriptionHtml}
                        </div>
                    </td>
                    <td>
                        ${assigneesHtml}
                    </td>
                    <td>
                        <span class="badge bg-light text-dark">${data.creator}</span>
                    </td>
                    <td>
                        <span class="badge bg-${priorityClasses[data.priority] || 'secondary'}">
                            ${priorityLabels[data.priority] || 'Normal'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-warning">Beklemede</span>
                    </td>
                    <td>
                        ${dueDateHtml}
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-outline-success ms-1" onclick='completeTask(${data.task_id}, ${JSON.stringify(data.title)})' title="Tamamlandı İşaretle">
                            <i class="fas fa-check"></i>
                        </button>
                    </td>
                </tr>
            `;
            
            // Prepend to table
            const tbody = $(targetContainerId);
            if (tbody.length) {
                // Remove "No tasks" alert if exists
                tbody.closest('.list-view').find('.alert-info').remove();
                // Ensure table exists (if it was empty before, it might not have the table structure)
                if (tbody.find('tr').length === 0 && !tbody.closest('table').length) {
                     // Reload page if structure is missing (simplest way to handle empty state transition)
                     location.reload();
                } else {
                    tbody.prepend(newRow);
                    
                    // Highlight new row
                    const insertedRow = tbody.find('tr').first();
                    insertedRow.css('background-color', '#e8f5e9');
                    setTimeout(() => {
                        insertedRow.css('background-color', '');
                    }, 2000);
                }
            }
            
            // Update badge count
            const badge = $(targetBadgeId);
            if (badge.length) {
                let count = parseInt(badge.text()) || 0;
                badge.text(count + 1);
            }
        });

        socket.on('task_completed', function(data) {
            console.log('✅ Task completed received:', data);
            
            const taskRow = $(`#task-row-${data.task_id}`);
            
            if (taskRow.length) {
                // Visual feedback
                taskRow.addClass('table-success');
                taskRow.find('td').css('background-color', '#d4edda'); // Bootstrap success color
                
                // If we are in "Active Tasks" or "Assigned Tasks" view, remove the row after delay
                const activeTabId = $('.tab-pane.active').attr('id');
                const isCompletedTab = activeTabId === 'completed-tasks';
                
                if (!isCompletedTab) {
                    setTimeout(() => {
                        taskRow.fadeOut(500, function() {
                            $(this).remove();
                            
                            // Update badges
                            // Decrease active count
                            const activeBadge = $('.nav-link.active .badge');
                            if (activeBadge.length) {
                                let count = parseInt(activeBadge.text()) || 0;
                                if (count > 0) activeBadge.text(count - 1);
                            }
                            
                            // Increase completed count
                            const completedBadge = $('#completed-tasks-tab .badge');
                            if (completedBadge.length) {
                                let count = parseInt(completedBadge.text()) || 0;
                                completedBadge.text(count + 1);
                            }
                            
                            // If no tasks left, show empty message
                            const tbody = taskRow.closest('tbody');
                            if (tbody.children('tr').length === 0) {
                                location.reload(); // Reload to show empty state correctly
                            }
                        });
                    }, 1000);
                } else {
                    // If we are already in completed tab, just update status badge
                    taskRow.find('.badge.bg-warning, .badge.bg-primary, .badge.bg-danger').removeClass('bg-warning bg-primary bg-danger').addClass('bg-success').text('Tamamlandı');
                    // Remove actions
                    taskRow.find('button').remove();
                }
            }
        });
    }
});

// Görev silme onayı (ana sayfa için)
function confirmDeleteIndex(taskId, taskTitle) {
    if (confirm(`"${taskTitle}" görevini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
        // Form oluştur ve submit et
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete_task/${taskId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// Görev tamamlama fonksiyonu
function completeTask(taskId, taskTitle) {
    if (confirm(`"${taskTitle}" görevini tamamlandı olarak işaretlemek istediğinizden emin misiniz?`)) {
        // AJAX ile tamamlama işlemi
        $.ajax({
            url: `/complete_task/${taskId}`,
            type: 'POST',
            success: function(result) {
                // Başarılıysa sayfayı yenile
                // location.reload(); // Handled by Socket.IO
                console.log('Task completion request successful');
            },
            error: function(xhr, status, error) {
                // Hata mesajı göster
                alert('Görev tamamlanırken bir hata oluştu. Lütfen tekrar deneyin.');
            }
        });
    }
}

// Görev açıklaması düzenleme fonksiyonu
function editTaskDescription(taskId) {
    // Önce görevin mevcut açıklamasını al
    $.get(`/get_task_description/${taskId}`)
        .then(function(response) {
            const currentDescription = response.description || '';
            
            // Modal dialog oluştur
            const modal = $(`
                <div class="modal fade" id="editDescriptionModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Görev Açıklamasını Düzenle</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label for="taskDescription" class="form-label">Açıklama</label>
                                    <textarea class="form-control" id="taskDescription" rows="6" placeholder="Görev açıklamasını yazın..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                                <button type="button" class="btn btn-primary" onclick="saveTaskDescription(${taskId})">Kaydet</button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            // Modal'ı ekle ve göster
            $('body').append(modal);
            $('#editDescriptionModal').modal('show');
            
            // Summernote'u başlat
            $('#taskDescription').summernote({
                height: 250,
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'italic', 'underline', 'clear']],
                    ['fontname', ['fontname]],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['custom', ['checkbox']],  // Checkbox button eklendi
                    ['table', ['table']],
                    ['insert', ['link', 'picture']],
                    ['view', ['fullscreen', 'codeview']],
                    ['help', ['help']]
                ],
                placeholder: 'Görev açıklamasını buraya yazın...\n\nCheckbox eklemek için toolbar\'daki □ butonunu kullanın.',
                tabsize: 2,
                focus: true,
                lang: 'tr-TR',
                callbacks: {
                    onInit: function() {
                        // Make checkbox texts editable
                        this.editableElement = this.note.editable[0];
                        $(this.editableElement).on('click', '.checkbox-text', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Make text editable
                            $(this).attr('contenteditable', 'true').focus();
                            
                            // Select all text
                            if (window.getSelection && document.createRange) {
                                const range = document.createRange();
                                range.selectNodeContents(this);
                                const selection = window.getSelection();
                                selection.removeAllRanges();
                                selection.addRange(range);
                            }
                        });
                        
                        // Handle blur to save changes
                        $(this.editableElement).on('blur', '.checkbox-text', function() {
                            $(this).removeAttr('contenteditable');
                        });
                    }
                }
            });
            
            // Mevcut açıklamayı Summernote'a yükle
            $('#taskDescription').summernote('code', currentDescription);
            
            // Modal kapandığında DOM'dan temizle ve Summernote'u yok et
            $('#editDescriptionModal').on('hidden.bs.modal', function () {
                $('#taskDescription').summernote('destroy');
                $(this).remove();
            });
        })
        .catch(function(error) {
            console.error('Açıklama yüklenirken hata:', error);
            alert('Açıklama yüklenirken bir hata oluştu.');
        });
}

// Açıklama kaydetme fonksiyonu
function saveTaskDescription(taskId) {
    // Summernote'dan HTML içeriği al
    const newDescription = $('#taskDescription').summernote('code').trim();
    
    // AJAX ile backend'e gönder
    $.ajax({
        url: `/edit_task_description/${taskId}`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            description: newDescription
        }),
        success: function(result) {
            if (result.success) {
                // Modal'ı kapat
                $('#editDescriptionModal').modal('hide');
                // Başarı mesajı göster
                alert(result.message);
                // Sayfayı yenile
                location.reload();
            } else {
                alert(result.message || 'Bir hata oluştu');
            }
        },
        error: function(xhr, status, error) {
            alert('Açıklama güncellenirken bir hata oluştu. Lütfen tekrar deneyin.');
        }
    });
}

// Görev silme fonksiyonu
function deleteTask(taskId, taskTitle) {
    if (confirm(`"${taskTitle}" görevini silmek istediğinizden emin misiniz?\n\nBu işlem geri alınamaz!`)) {
        // AJAX ile silme işlemi
        $.ajax({
            url: `/delete_task/${taskId}`,
            type: 'POST',
            success: function(result) {
                // Başarılıysa sayfayı yenile
                location.reload();
            },
            error: function(xhr, status, error) {
                // Hata mesajı göster
                alert('Görev silinirken bir hata oluştu. Lütfen tekrar deneyin.');
            }
        });
    }
}

// Swipe Actions for Mobile (Kaydırma Hareketleri)
document.addEventListener('DOMContentLoaded', function() {
    const taskRows = document.querySelectorAll('.task-row');
    
    taskRows.forEach(row => {
        let startX;
        let startY;
        let currentX;
        let isSwiping = false;
        const threshold = 100; // Minimum distance to trigger action
        
        row.addEventListener('touchstart', (e) => {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
            isSwiping = true;
            row.style.transition = 'none'; // Disable transition during swipe
        }, { passive: true });
        
        row.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            
            currentX = e.touches[0].clientX;
            const currentY = e.touches[0].clientY;
            const diffX = currentX - startX;
            const diffY = currentY - startY;

            // If vertical scroll is dominant, ignore horizontal swipe
            if (Math.abs(diffY) > Math.abs(diffX)) {
                // Let the browser handle scrolling
                return;
            }
            
            // If horizontal swipe is dominant, prevent default scrolling
            if (e.cancelable && Math.abs(diffX) > 10) {
                 e.preventDefault(); 
            }

            // Limit swipe distance visually
            if (Math.abs(diffX) < 200) {
                row.style.transform = `translateX(${diffX}px)`;
                
                // Visual feedback
                if (diffX > 50) {
                    // Swiping Right (Complete)
                    row.style.backgroundColor = `rgba(25, 135, 84, ${Math.min(Math.abs(diffX)/200, 0.2)})`; // Green tint
                } else if (diffX < -50) {
                    // Swiping Left (Delete)
                    row.style.backgroundColor = `rgba(220, 53, 69, ${Math.min(Math.abs(diffX)/200, 0.2)})`; // Red tint
                } else {
                    row.style.backgroundColor = '';
                }
            }
        }, { passive: false }); // passive: false is needed to use preventDefault
        
        row.addEventListener('touchend', (e) => {
            if (!isSwiping) return;
            isSwiping = false;
            row.style.transition = 'transform 0.3s ease, background-color 0.3s ease';
            
            // If currentX is undefined (tap without move), reset
            if (!currentX) {
                 currentX = startX;
            }

            const diff = currentX - startX;
            
            if (diff > threshold) {
                // Swipe Right -> Complete
                const completeBtn = row.querySelector('button[onclick^="completeTask"]');
                if (completeBtn) {
                    // Reset visual before action
                    row.style.transform = 'translateX(0)';
                    row.style.backgroundColor = '';
                    setTimeout(() => completeBtn.click(), 100);
                } else {
                     // Reset if action not available
                    row.style.transform = 'translateX(0)';
                    row.style.backgroundColor = '';
                }
            } else if (diff < -threshold) {
                // Swipe Left -> Delete
                const deleteBtn = row.querySelector('button[onclick^="deleteTask"]');
                if (deleteBtn) {
                    // Reset visual before action
                    row.style.transform = 'translateX(0)';
                    row.style.backgroundColor = '';
                    setTimeout(() => deleteBtn.click(), 100);
                } else {
                    // Reset if action not available
                    row.style.transform = 'translateX(0)';
                    row.style.backgroundColor = '';
                }
            } else {
                // Reset
                row.style.transform = 'translateX(0)';
                row.style.backgroundColor = '';
            }
            // Reset coordinates
            currentX = undefined;
        });
    });
});
</script>
{% endblock %}
