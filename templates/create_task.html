{% extends "base.html" %}

{% block title %}Yeni Görev - Helmex{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus"></i> Yeni Görev Oluştur</h4>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="title" class="form-label">Görev Başlığı *</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Açıklama</label>
                        <textarea class="form-control" id="description" name="description" rows="6"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="attachments" class="form-label">
                            <i class="fas fa-paperclip"></i> Dosya Ekle
                        </label>
                        <input type="file" class="form-control" id="attachments" name="attachments" multiple>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 
                            Birden fazla dosya seçebilirsiniz. İzin verilen türler: PDF, Word, Excel, PowerPoint, Resim (JPG, PNG), Arşiv (ZIP, RAR). Maksimum dosya boyutu: 16MB
                        </small>
                        <div id="file-preview" class="mt-2"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assigned_to" class="form-label">Atanacak Kişiler *</label>
                                <select class="form-select" id="assigned_to" name="assigned_to" multiple required size="8">
                                    {% for user in users %}
                                        <option value="{{ user.id }}" data-role="{{ user.role }}" data-dept="{{ user.department or 'Belirtilmemiş' }}">
                                            {{ user.username }} 
                                            {% if user.role == 'manager' %}
                                                (Manager)
                                            {% elif user.role == 'admin' %}
                                                (Admin)
                                            {% endif %}
                                            - {{ user.department or 'Departman belirtilmemiş' }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    {% if current_user.role == 'manager' %}
                                        Ctrl/Cmd tuşu ile birden fazla kişi seçebilirsiniz. Kendi departmanınızdaki çalışanlara ve diğer manager'lara görev atayabilirsiniz.
                                    {% else %}
                                        Ctrl/Cmd tuşu ile birden fazla kişi seçebilirsiniz.
                                    {% endif %}
                                </small>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="selectAll()">
                                        <i class="fas fa-check-double"></i> Tümünü Seç
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                                        <i class="fas fa-times"></i> Seçimi Temizle
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Öncelik</label>
                                <select class="form-select" id="priority" name="priority">
                                    <option value="low">Düşük</option>
                                    <option value="medium" selected>Orta</option>
                                    <option value="high">Yüksek</option>
                                    <option value="urgent">Acil</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="due_date" class="form-label">Bitiş Tarihi</label>
                        <input type="date" class="form-control" id="due_date" name="due_date" min="{{ moment.istanbul_now().strftime('%Y-%m-%d') }}">
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Görevi Oluştur
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> İptal
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Bugünün tarihini minimum tarih olarak ayarla
    const today = new Date().toISOString().split('T')[0];
    $('#due_date').attr('min', today);
    
    // Dosya seçimi önizleme
    $('#attachments').on('change', function() {
        const files = this.files;
        const preview = $('#file-preview');
        preview.empty();
        
        if (files.length > 0) {
            const fileList = $('<div class="alert alert-info"><strong>Seçilen Dosyalar:</strong><ul class="mb-0 mt-2"></ul></div>');
            const ul = fileList.find('ul');
            
            Array.from(files).forEach(file => {
                const fileSize = (file.size / 1024).toFixed(2); // KB
                const icon = getFileIcon(file.name);
                ul.append(`<li><i class="${icon}"></i> ${file.name} (${fileSize} KB)</li>`);
            });
            
            preview.append(fileList);
        }
    });
    
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'fas fa-file-pdf text-danger',
            'doc': 'fas fa-file-word text-primary',
            'docx': 'fas fa-file-word text-primary',
            'xls': 'fas fa-file-excel text-success',
            'xlsx': 'fas fa-file-excel text-success',
            'ppt': 'fas fa-file-powerpoint text-warning',
            'pptx': 'fas fa-file-powerpoint text-warning',
            'jpg': 'fas fa-file-image text-info',
            'jpeg': 'fas fa-file-image text-info',
            'png': 'fas fa-file-image text-info',
            'gif': 'fas fa-file-image text-info',
            'zip': 'fas fa-file-archive text-secondary',
            'rar': 'fas fa-file-archive text-secondary',
            'txt': 'fas fa-file-alt text-muted'
        };
        return icons[ext] || 'fas fa-file';
    }
    
    // Summernote zengin metin editörünü başlat
    $('#description').summernote({
        height: 200,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'clear']],
            ['fontname', ['fontname']],
            ['color', ['color']],
            ['para', ['ul', 'ol', 'paragraph']],
            ['custom', ['checkbox']],  // Checkbox button eklendi
            ['table', ['table']],
            ['insert', ['link', 'picture']],
            ['view', ['fullscreen', 'codeview']],
            ['help', ['help']]
        ],
        placeholder: 'Görev açıklamasını buraya yazın...\n\nCheckbox eklemek için toolbar\'daki □ butonunu kullanın.',
        tabsize: 2,
        focus: false,
        lang: 'tr-TR',
        callbacks: {
            onInit: function() {
                // Make checkbox texts editable
                this.editableElement = this.note.editable[0];
                $(this.editableElement).on('click', '.checkbox-text', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Make text editable
                    $(this).attr('contenteditable', 'true').focus();
                    
                    // Select all text
                    if (window.getSelection && document.createRange) {
                        const range = document.createRange();
                        range.selectNodeContents(this);
                        const selection = window.getSelection();
                        selection.removeAllRanges();
                        selection.addRange(range);
                    }
                });
                
                // Handle blur to save changes
                $(this.editableElement).on('blur', '.checkbox-text', function() {
                    $(this).removeAttr('contenteditable');
                });
            }
        }
    });
});
</script>
{% endblock %}
